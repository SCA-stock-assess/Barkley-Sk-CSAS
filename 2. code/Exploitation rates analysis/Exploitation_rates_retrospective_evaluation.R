# Packages ----------------------------------------------------------------


pkgs <- c("tidyverse", "here", "readxl", "ggrepel")
#install.packages(pkgs)


library(here)
library(tidyverse); theme_set(theme_bw())
library(readxl)
library(ggrepel)

# Load common functions
source(here("2. code", "0. functions", "common_functions.R"))


# Load post-season run size data for Somass and Hucuktlis -----------------


# Cleaned stock-recruit data
sr_data <- here(
  "3. outputs",
  "Stock-recruit data",
  "Barkley_Sockeye_stock-recruit_infilled.xlsx"
) |> 
  read_xlsx(sheet = "S-R data")


# Run size data and exploitation rates
er_data <- sr_data |> 
  rowwise() |> 
  mutate(
    adult_prop = if_else(
      if_any(matches("N.age.\\d"), is.na),
      1,
      sum(c_across(matches("N.age.\\d")))
    ),
    run = N * adult_prop,
    catch = H * adult_prop,
    group = if_else(stock == "HUC", "Hucuktlis", "Somass")
  ) |> 
  ungroup() |> 
  summarize(
    .by = c(year, group),
    across(c(run, catch), sum)
  ) |> 
  rowwise() |> 
  mutate(
    er = catch/run,
    target_er = case_when(
      group == "Somass" ~ somass_mgt_rule(run),
      group == "Hucuktlis" & year > 2011 ~ hucuktlis_mgt_rule(run),
      .default = NA
    )
  )



# Plots to evaluate harvest performance -----------------------------------


# Data frame constraining years to only those when the management plan applies
er_data_trim <- er_data |> 
  filter(year > 2000)  |> 
  pivot_longer(contains("er")) |> 
  mutate(
    .by = group,
    sec_axis_y = value*max(run),
    name = if_else(
      name == "er",
      "Observed ER",
      "Target ER"
    )
  ) 


# Set up a hacky second axis to annotate the harvest rate percentages
sec_axis_txt <- er_data_trim |> 
  mutate(year = (max(year)-min(year))*1.05 + min(year)) |> 
  summarize(
    .by = c(group, year),
    max = max(run)
  ) |> 
  expand_grid(label = seq(0, 1, by = 0.25)) |> 
  mutate(
    run = max*label,
    label = scales::percent(label)
  )


# Plot of target versus actual er over observed run sizes
(er_vs_abun_p <- er_data_trim |> 
  ggplot(aes(x = year, y = run)) +
  facet_wrap(
    ~group,
    ncol = 1,
    scales = "free_y"
  ) +
  geom_col(fill = "grey", position = position_identity()) +
  geom_line(
    aes(
      y = sec_axis_y,
      colour = name
      ),
    key_glyph = "timeseries"
  ) +
  geom_text(
    data = sec_axis_txt,
    aes(label = label),
    hjust = -0.2,
    vjust = 0.25,
    size = 3
  ) +
  scale_y_continuous(
    limits = c(0, NA),
    expand = expansion(mult = c(0, 0.05)),
    labels = ~./1000,
    sec.axis = dup_axis(name = "Exploitation rate")
  ) +
  scale_colour_manual(values = c("red", "black")) +
  coord_cartesian(
    xlim = c(min(er_data_trim$year), max(er_data_trim$year)),
    clip = "off"
  ) +
  labs(
    y = "Run size (1000s)",
    x = "Return year"
  ) +
  theme(
    panel.spacing.y = unit(1, "lines"),
    panel.grid.minor = element_blank(),
    legend.title = element_blank(),
    legend.position = "inside",
    legend.position.inside = c(0.05, 0.95),
    legend.justification.inside = c(0, 1),
    legend.background = element_rect(colour = "black"),
    plot.margin = unit(c(1,3,1,1), "lines"),
    axis.ticks.y = element_blank(),
    axis.text.y.right = element_blank(),
    axis.title.y.right = element_text(vjust = 13),
    strip.background = element_blank()
  )
)


# Export the plot
ggsave(
  plot = er_vs_abun_p,
  filename = here(
    "3. outputs",
    "Plots",
    "Hucuktlis_vs_Somass_er_w-abundance.png"
  ),
  width = 6.5,
  height = 5,
  units = "in",
  dpi = "print"
)


# Report on annual exceedances for Hucuktlis ------------------------------


# Produce a simple table summary
er_data |> 
  ungroup() |> 
  mutate(error = er - target_er) |> 
  filter(
    # Include only years when current MGT plans were in effect
    case_when(
      group == "Somass" & year > 1993 ~ TRUE,
      group == "Hucuktlis" & year > 2011 ~ TRUE,
      .default = FALSE
    )
  ) |>
  add_count(group, name = "ttl_years") |> 
  filter(error > 0) |> # Focus only on exceeded years 
  summarize(
    .by = c(group, ttl_years),
    av_err = mean(error, na.rm = TRUE),
    median_err = median(error, na.rm = TRUE),
    years_exceeded = n()
  ) |> 
  mutate(pct_exceeded = years_exceeded/ttl_years)





# Hucuktlis-Somass ER correlation model (frequentist) ---------------------


# Build time series of Hucuktlis and Somass ERs
er_ts <- here(
  "3. outputs",
  "Stock-recruit data",
  "Barkley_Sockeye_stock-recruit_infilled.xlsx"
) |> 
  read_xlsx(sheet = "S-R data") |> 
  filter(year > 2011) |> 
  mutate(stock = if_else(stock == "HUC", "Hucuktlis", "Somass")) |> 
  summarize(
    .by = c(year, stock),
    across(c(N, H), sum)
  ) |> 
  mutate(er = H/N) |> 
  pivot_wider(
    id_cols = year,
    names_from = stock,
    values_from = c(N, H, er),
    names_glue = "{stock}_{.value}"
  ) |> 
  # Zero-center the abundances
  mutate(
    Somass_N_c = scale(Somass_N, scale = FALSE),
    Hucuktlis_N_c = scale(Hucuktlis_N, scale = FALSE)
  )


# Build a GLM describing the relationship
er_model <- glm(
  Hucuktlis_er ~ Somass_er * Somass_N_c + Hucuktlis_N_c,
  data = er_ts,
  family = quasibinomial()
)


# High level inference on model terms
summary(er_model)
car::Anova(er_model, type = 3) # Somass ER and abundance (but not Hucuktlis 
                               # abundance) predict Hucuktlis ER. 


# Make a prediction dataset
er_pred_frame <- tibble(
  # Predict across a range of Somass abundances
  Somass_N = seq(0,1.5e6, by = c(5e4)),
  # Fix Hucuktlis abundance to its (zero-centered) mean value
  Hucuktlis_N_c = as.matrix(0)
) |> 
  rowwise() |> 
  mutate(
    Somass_er = somass_mgt_rule(Somass_N),
    Somass_N_c = as.matrix(Somass_N - attr(er_ts$Somass_N_c, "scaled:center"))
  ) |> 
  ungroup() |> 
  # Do not predict outside the upper range of observed data
  filter(Somass_er <= max(er_ts$Somass_er))


# Bind predictions to data
er_preds <- predict(
  er_model, 
  er_pred_frame, 
  type = "link",
  se.fit = TRUE
) |> 
  discard_at("residual.scale") |> 
  as.data.frame() |> 
  mutate(
    lci = fit - 1.96*se.fit,
    uci = fit + 1.96*se.fit,
    across(c(fit, lci, uci), binomial()$linkinv)
  ) |>
  cbind(er_pred_frame)


# Plot the predictions
(er_pred_plot <- er_preds |> 
  ggplot(aes(y = fit, x = Somass_er)) +
  geom_abline(slope = 1, lty = 2) +
  geom_line() +
  geom_ribbon(
    aes(ymin = lci, ymax = uci),
    alpha = 0.2
  ) +
  geom_point(
    data = er_ts,
    aes(
      y = Hucuktlis_er, 
      x = Somass_er,
      size = Somass_N
    )
  ) +
  geom_text_repel(
    data = er_ts,
    aes(
      y = Hucuktlis_er, 
      x = Somass_er,
      label = year
    )
  ) +
  # annotate(
  #   "text",
  #   label = "*Note: these predictions assume no\nimplementation error in Somass HCR",
  #   x = 0.01,
  #   y = 0.5,
  #   hjust = 0,
  #   vjust = 1,
  #   colour = "grey40"
  # ) +
  scale_y_continuous(
    limits = c(0, 0.8),
    labels = scales::percent,
    expand = c(0, 0)
  ) +
  scale_x_continuous(
    limits = c(0, 0.7),
    labels = scales::percent,
    expand = c(0, 0)
  ) +
  scale_size_continuous(labels = scales::label_number()) +
  coord_fixed(ratio = 1) +
  labs(
    x = "Somass Sockeye exploitation rate",
    y = "Hucuktlis Sockeye exploitation rate",
    size = "Somass Sockeye\nabundance"
  ) +
  theme(
    legend.position = "inside",
    legend.position.inside = c(0, 1),
    legend.justification.inside = c(0, 1),
    legend.background = element_rect(colour = "grey20", linewidth = 0.25)
  )
)
# This looks like a reasonable predictive model when we take
# Somass and Hucuktlis abundance into account as well


# Save the plot
ggsave(
  plot = er_pred_plot,
  filename = here(
    "3. outputs",
    "Plots",
    "Hucuktlis_vs_Somass_HRs_2012-2024.png"
  ),
  width = 5.25,
  height = 6,
  units = "in",
  dpi = "print"
)


# Investigate effects of upstream migration delays ------------------------


# Load daily escapement data
esc <- here(
  "3. outputs",
  "Collated daily escapement data",
  "Barkley_Sockeye_daily_escapements_by_CU.csv"
) |> 
  read.csv() |> 
  mutate(
    date = as.Date(paste0(d_m, "-", year), format = "%d-%b-%Y"),
    doy = format(date, "%j") |> as.numeric(),
    stock = if_else(system == "HUC", "Hucuktlis", "Somass")
  ) |> 
  filter(!is.na(sockeye)) |> 
  arrange(system, date) |> 
  # Add daily cumulative proportions by system and year
  mutate(
    .by = c(system, year),
    ann_ttl = sum(sockeye),
    daily_prop = sockeye/ann_ttl,
    cum_prop = cumsum(daily_prop)
  )


# Calculate annual 50% dates for each system and stock
ann_50_doy <- c("sys" = "system", "stk" = "stock") |> 
  map(
    \(x) esc |> 
      filter(
        .by = all_of(x),
        cum_prop > 0.5
      ) |> 
      # ensure (again) that dates are correctly ordered
      arrange(.data[[x]], date) |> 
      # Remove all rows subsequent to the 50% threshold for each system and year
      distinct(.data[[x]], year, .keep_all = TRUE) |> 
      rename("ann_50_doy" = doy) |> 
      mutate(
        .by = all_of(x),
        ann_50_doy_quant = ecdf(ann_50_doy)(ann_50_doy)
      ) |> 
      select(year, all_of(x), ann_50_doy, ann_50_doy_quant)
  )


# Plot Hucuktlis ER versus Somass 50% date quantiles
ann_50_doy$stk |> 
  filter(
    year >= min(er_ts$year),
    stock == "Somass"
  ) |> 
  left_join(er_ts) |> 
  ggplot(aes(x = ann_50_doy_quant, y = Hucuktlis_er)) +
  geom_point(aes(size = Somass_N)) +
  geom_smooth(
    method = "glm", 
    aes(weight = Somass_N),
    method.args = list(family = "quasibinomial")
  )
# No compelling relationship here


# Hucuktlis ER versus percentage of run that escaped > 1 July?
esc |> 
  filter(
    stock == "Somass",
    year >= min(er_ts$year),
    doy >= 183
  ) |> 
  summarize(
    .by = c(year),
    pct_esc = 1-min(cum_prop)
  ) |> 
  left_join(er_ts) |> 
  ggplot(aes(x = pct_esc, y = Hucuktlis_er)) +
  geom_point(aes(size = Somass_N)) +
  geom_smooth(
    method = "glm", 
    aes(weight = Somass_N),
    method.args = list(family = "quasibinomial")
  ) +
  labs(
    y = "Hucuktlis ER",
    x = "Percentage of Somass escapement occurring after 1 July"
  )
# No compelling relationship here either

